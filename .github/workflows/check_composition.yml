name: rtype-server-test

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

defaults:
  run:
    shell: bash

jobs:
  check_program_compilation:
    runs-on: [self-hosted, Linux, X64, sandbox]
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install C dependencies
        uses: mbarleon-org/install-c-deps@v1

      - name: Ensure cmake & ninja (Linux)
        run: |
          set -e
          HAVE_CMAKE=0
          HAVE_NINJA=0
          command -v cmake >/dev/null 2>&1 && HAVE_CMAKE=1
          command -v ninja >/dev/null 2>&1 && HAVE_NINJA=1

          if [ "$HAVE_CMAKE" = 1 ] && [ "$HAVE_NINJA" = 1 ]; then
            echo "::notice::cmake and ninja already available:"
            cmake --version | head -n1
            ninja --version
            exit 0
          fi

          echo "::notice::Installing missing tools via apt (noninteractive, no recommends)â€¦"
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get -yq update
          sudo apt-get -yq install --no-install-recommends \
          ${HAVE_CMAKE:+} ${HAVE_CMAKE:+"ninja-build"} \
          ${HAVE_NINJA:+} ${HAVE_NINJA:+"cmake"}
          sudo rm -rf /var/lib/apt/lists/*

          cmake --version | head -n1
          ninja --version

      - name: Check & run build.sh (Linux)
        run: |
          test -f build.sh || { echo "::error ::/!\\ WARNING NO build.sh FOUND /!\\"; exit 84; }
          chmod +x build.sh
          ./build.sh

      - name: Check executable (Linux)
        env:
          EXECUTABLE_PATH: ${{ vars.EXECUTABLE_PATH }}
        run: |
          executable="${EXECUTABLE_PATH}"
          if [ -z "$executable" ]; then
            echo "::error ::EXECUTABLE_PATH is not set."
            exit 84
          fi
          if [ -x "$executable" ] || [ -f "$executable" ]; then
            echo "::notice file=$executable::Executable found."
          else
            echo "::error file=$executable::Executable missing."
            ls -la
            exit 84
          fi

      - name: Check required libraries on Linux
        env:
          REQUIRED_LIBS: ${{ vars.REQUIRED_LIBS }}
        run: |
          for lib in $REQUIRED_LIBS; do
            found=0
            for ext in so a; do
              if [ -f "lib${lib}.${ext}" ]; then
                path="lib${lib}.${ext}"
              elif [ -f "build/lib/lib${lib}.${ext}" ]; then
                path="build/lib/lib${lib}.${ext}"
              fi

              if [ -n "${path:-}" ]; then
                echo "::notice file=${path}::Found $lib (${ext})"
                found=1
              fi
            done
            if [ $found -eq 0 ]; then
              echo "::error file=lib${lib}::Missing $lib"
              exit 84
            fi
          done
